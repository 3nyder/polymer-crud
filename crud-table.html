<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-aja/iron-aja.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">

<!--
An sortable, filtrable data table from api url.

Example:

    <crud-table></crud-table>

Example:
    <crud-table
      url="/api/bears"
      model="bearModel"
      actions="edit,delete"
    >
    </crud-table>



@demo demo/index.html
@hero hero.svg
-->
<dom-module id="crud-table" attributes="model setname actions url">
  </style>
  <template>
    <style include="shared-styles"></style>
    <style>
      .table-container {
        height: 100%;
        overflow-y: auto;
      }
      table {
        width: 100%;
        max-width: 100%;
        background-color: transparent;
        border-collapse: collapse;
        border-spacing: 0;
      }
      th.current {
        color: black !important;
      }
      th.orderable {
        cursor: pointer;
      }
      th {
        text-align: left;
        font-weight: 500;
        font-size: 15px;
        color: var(--secondary-text-color);
        padding: 10px;
      }
      td {
        font-size: 15px;
        color: var(--primary-text-color);
        padding: 0 8px;
        line-height: 45px;
      }
      tr {
        line-height: 40px;
      }
      tr:hover td, tr.itemActive {
         background: var(--paper-indigo-50);
      }
      paper-toolbar.white {
            --paper-toolbar-background: white;
            --paper-toolbar-title: {
              font-style: italic;
              font-weight: bold;
            };
      }
    </style>
    <iron-ajax auto
      id = "ajax"
        url="{{url}}"
        handle-as="json"
        on-response="fetchData"
        last-response="{{ajaxResponse}}"></iron-ajax>

    <paper-toolbar class="white" id="tableHeader" >
      <div class="flex"></div>
      <paper-icon-button icon="search" on-tap="toggleSearch"></paper-icon-button>
      <paper-input value="{{filterQuery::input}}" label="Filter Items"  on-blur="hideSearch"></paper-input>
      <template is="dom-repeat" items="[[actions]]">
        <paper-icon-button class="actions" icon$="{{item.icon}}" data-event$="{{item.event}}" on-tap="fireEvent"></paper-icon-button>
      </template>


    </paper-toolbar>


    <div class="table-container">
      <table>
        <thead>
          <tr>
          <!-- Columns name -->
            <template is="dom-repeat" items="[[columns]]">
              <template is="dom-if" if="{{item.orderable}}">
                <th on-click="orderBy" data-key$="{{item.key}}" class="orderable">{{item.value}}</th>
              </template>
              <template is="dom-if" if="{{!item.orderable}}">
                <th >{{item.value}}</th>
              </template>
            </template>

          </tr>
        </thead>
        <tbody>
          <template id="resultList" is="dom-repeat" filter="customFilter" items="[[values]]">
            <tr data-uid$="{{item.id}}" on-click="showActions" class="horizontal-section">
              <template id="resultList" is="dom-repeat" items="[[item.values]]">
                <td>{{item}}</td>
              </template>
              <td hidden>{{item.searcheable}}</td>
            </tr>
          </template>
        </tbody>
      </table>
      <div id="paginado">
      </div>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'crud-table',

        properties: {
          model: {
            type: Object,
          },
          /* Get the column names from the model */
          colums : {
            type : Array
          },
          actions : {
            type : Array,
            value : [
            {
              title : 'Edit',
              event : 'crud-edit',
              icon  : 'create'
            },
            {
              title : 'Delete',
              event : 'crud-delete',
              icon  : 'delete'
            }]
          },
          backgroundData : {
            type : Array
          },
          /*  fetched data from the columns to show and id */
          fetchedData : {
            type : Object
          },
          values:  {
            type :Array,
            observer : 'drawTable'
          },
          idname : {
            type: String,
            value : '_id'
          },
          setname : {
            type :  String,
          },
          filterQuery : {
            type : String,
            value : '',
            observer : 'drawTable'
          }, 
          keySort : {
            type :  String,
            value : '',
            observer: 'drawTable'
          },
          nResults : {
            type : Number,
            value : 10,
            observer : 'drawTable'
          },
          currentPage : {
            type : Number,
            value : 1,
            observer : 'drawTable'
          },
          currentBatch : {
            type : Array,
            notify : true,
            observer : 'drawTable'
          }
        },

        ready :  function () {
          this.columns = this.getColumnsName();
        },

        showActions :  function (e) {
          var previous = document.querySelectorAll('tr.itemActive');
          Array.prototype.slice.call(previous).map(function(ee){
            ee.className = ee.className.replace('itemActive', '');
          });

          var id = e.srcElement.parentElement.getAttribute('data-uid');
           e.srcElement.parentElement.className += ' itemActive';
          var actions = document.querySelectorAll('.actions');
          Array.prototype.slice.call(actions).map(function(ee){
            ee.setAttribute('data-uid', id);
          });
        },

        orderBy : function (e) {
          var keySort = e.srcElement.getAttribute('data-key');
          var elements = document.querySelectorAll('.current');
          Array.prototype.slice.call(elements).map(function(ee){
            ee.className = ee.className.replace('current ','');
          });
          e.srcElement.className = 'current ' + e.srcElement.className;
          this.keySort = keySort;
          this.getBatchData();
          this.drawTable();
        },
        customSort :  function (a,b) {
        },
        refreshTable : function () {
          var jx = document.querySelector("#ajax");
          jx.generateRequest();
        },
        customFilter : function (e) {
          return e.searcheable.match(new RegExp(this.filterQuery, 'i'));
        },
        fireEvent : function(e) {
          var id = e.srcElement.parentElement.getAttribute('data-uid');
          var evnt = e.srcElement.parentElement.getAttribute('data-event');
          this.fire(evnt, { id: id});
        },
        drawTable :  function () {
          this.$.resultList.render();
        },
        getBatchData :  function () {
          var data = this.backgroundData;
          var currentPage = this.currentPage;
          var nResults = this.nResults;
          var filter = this.filterQuery;
          var kS = this.keySort;
          var filterData = [];
          if (kS) {
            filterData = this.sortData(data, kS);
          }
          this.values = filterData;
        },
        sortData : function (data, keySort, reverse) {
          return data.sort(function(a,b) {
            if (typeof a[keySort] == 'undefined')
              a[keySort] = '';
            if (typeof b[keySort] == 'undefined')
              b[keySort] = '';
            if (!reverse)
              return a[keySort].toLowerCase() === b[keySort].toLowerCase() ? 0 : a[keySort].toLowerCase() > b[keySort].toLowerCase() ? 1 : -1;
            return a[keySort].toLowerCase() === b[keySort].toLowerCase() ? 0 : a[keySort].toLowerCase() > b[keySort].toLowerCase() ? -1 : 1;
          });
        },
        getColumnsName : function () {
          var model = this.model;
          var visibles = this.getAttributesWith('hidden', false);
          var orderables = this.getAttributesWith('orderable', true);
          var candidates =  this.getAttributesWith('', false);
          var winners =  [];
          this.model.forEach(function(c) {
            if(visibles.indexOf(c['key']) != -1) {
              var winer = {
                key : c['key'],
                value : c['label'] || c['key'],
                orderable : (orderables.indexOf(c['key']) != -1)
              };

              winners.push(winer);
            }
          });
          return winners;
        },
        getAttributesWith: function(prop, val){
          var m = this.model;
          var candidates = [];
          m.forEach(function(attr) {
            if (prop in attr) {
              if (attr[prop] == true) {
                candidates.push(attr.key);
              }
            } else {
              candidates.push(attr.key)
            }
          });
          return candidates;
        },

        /* fetch the data from the api */
        fetchData : function (e) {
          var data = e.detail.xhr.response;
          this.backgroundData = data;
          var columns  = this.getAttributesWith('hidden',false)
          var searchables = this.getAttributesWith('searchable', true);
          var values = [];
          var self =  this;
          data.forEach(function(element) {
            var _row = {
              values : [],
              searcheable : '',
              id : 0
            };
            columns.forEach(function(column){
              if (column && element[column]) {
                _row.values.push(element[column])
              } else if (column){
                _row.values.push('');
              }
            });
            searchables.forEach(function(searcheable){
              if (searcheable != '' && element[searcheable]) {
                _row.searcheable += ' ' + element[searcheable];
              }
            });

            _row.id = element[self.idname];
            values.push(_row);
            element.values = _row.values;
            element.searcheable = _row.searcheable;
          });
          this.values = data;
        }, 
        someFilter :  function (e) {}
      });
    })();
  </script>

</dom-module>